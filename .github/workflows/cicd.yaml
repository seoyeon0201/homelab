name: Self-hosted Runner CI/CD

on:
  push:
    branches:
      - github-cicd
    paths:
      - 'week3/cicd/**'
      - '.github/workflows/**'

jobs:
  build-and-deploy:
    name: Build & Push Docker Image
    runs-on: self-hosted  # self-hosted Îü¨ÎÑà ÏÇ¨Ïö©

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check and Install Python
        run: |
          echo "üîç Checking Python..."
          if ! command -v python3 &> /dev/null; then
            echo "‚ö†Ô∏è Python not found. Installing Python 3.9..."
            sudo apt update
            sudo apt install -y python3 python3-pip python3-venv
          else
            echo "‚úÖ Python version: $(python3 --version)"
          fi

          echo "üîç Checking pip..."
          if ! command -v pip3 &> /dev/null; then
            echo "‚ö†Ô∏è pip not found. Installing pip..."
            sudo apt install -y python3-pip
          else
            echo "‚úÖ pip version: $(pip3 --version)"
          fi
      
      - name: Install dependencies
        run: |
          cd week3/cicd
          pip install -r requirements.txt

      - name: Check and Install Docker
        run: |
          echo "üîç Checking Docker..."
          if ! command -v docker &> /dev/null; then
            echo "‚ö†Ô∏è Docker not found. Installing..."
            curl -fsSL https://get.docker.com | sudo sh
          else
            echo "‚úÖ Docker is already installed: $(docker --version)"
          fi
          
      - name: Log in to DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image and Push Docker image to DockerHub
        run: |
          cd week3/cicd
          sudo docker build -t ${{ secrets.DOCKER_USERNAME }}/selfhosted-flask-app:latest .
          sudo docker push ${{ secrets.DOCKER_USERNAME }}/selfhosted-flask-app:latest
